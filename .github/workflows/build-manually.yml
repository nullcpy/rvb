name: Build Manually

on:
  workflow_dispatch:

concurrency:
  group: patch-build
  cancel-in-progress: false

jobs:
  build:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Setup Java (Zulu 17)
        uses: actions/setup-java@v5
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: true

      - name: Get Next Version Code
        id: next_ver_code
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG=$(gh release list --exclude-drafts -L 100 | awk -F '\t' '$3 ~ /^[0-9]+$/ { print $3 }' | sort -nr | head -n1)
          if [ -z "$TAG" ] || ! [[ "$TAG" =~ ^[0-9]+$ ]]; then TAG=0; fi
          echo "NEXT_VER_CODE=$((TAG + 1))" >> "$GITHUB_OUTPUT"

      - name: Build Modules and APKs
        run: |
          set -euo pipefail
          if [ -f ".github/misc/config.manual.toml" ]; then
            ./build.sh .github/misc/config.manual.toml
          else
            ./build.sh config.toml
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: $GITHUB_REPOSITORY
          NEXT_VER_CODE: ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}

      - name: Get Output
        id: get_output
        run: |
          set -euo pipefail
          DELIM="$(openssl rand -hex 8)"
          echo "BUILD_LOG<<${DELIM}" >> "$GITHUB_OUTPUT"
          cat build.md >> "$GITHUB_OUTPUT"
          echo "${DELIM}" >> "$GITHUB_OUTPUT"
          cp -f build.md build.tmp

      - name: Check Prerelease Status
        id: check_prerelease
        run: |
          set -euo pipefail
          if [ -f ".github/misc/config.manual.toml" ]; then
            CONFIG=".github/misc/config.manual.toml"
          else
            CONFIG="config.toml"
          fi

          if grep -Fq 'patches-version = "dev"' "$CONFIG"; then
            echo "IS_PRERELEASE=true" >> "$GITHUB_OUTPUT"
            echo "TITLE_SUFFIX= (Pre-release)" >> "$GITHUB_OUTPUT"
            echo "Status: Prerelease."
          else
            echo "IS_PRERELEASE=false" >> "$GITHUB_OUTPUT"
            echo "TITLE_SUFFIX=" >> "$GITHUB_OUTPUT"
            echo "Status: Release."
          fi

      - name: Upload to Release
        uses: svenstaro/upload-release-action@v2
        with:
          body: ${{ steps.get_output.outputs.BUILD_LOG }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./build/*
          file_glob: true
          release_name: Build No. ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}
          tag: ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}
          overwrite: true
          prerelease: ${{ steps.check_prerelease.outputs.IS_PRERELEASE }}

      - name: Update Changelog and Magisk Update JSON
        id: update_config
        run: |
          set -euo pipefail
          git checkout -f update || git switch --discard-changes --orphan update
          cp -f build.tmp build.md

          get_update_json() {
            echo "{
            \"version\": \"$1\",
            \"versionCode\": ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }},
            \"zipUrl\": \"$2\",
            \"changelog\": \"https://raw.githubusercontent.com/$GITHUB_REPOSITORY/update/build.md\"
          }"
          }

          cd build || { echo "build folder not found"; exit 1; }
          for OUTPUT in *magisk*.zip; do
            [ "$OUTPUT" = "*magisk*.zip" ] && continue
            ZIP_S=$(unzip -p "$OUTPUT" module.prop)
            if ! UPDATE_JSON=$(echo "$ZIP_S" | grep updateJson); then continue; fi
            UPDATE_JSON="${UPDATE_JSON##*/}"
            VER=$(echo "$ZIP_S" | grep version=)
            VER="${VER##*=}"
            DLURL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/download/${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}/${OUTPUT}"
            get_update_json "$VER" "$DLURL" >"../$UPDATE_JSON"
          done
          cd ..

          find . -name "*-update.json" | grep . || : >dummy-update.json

      - name: Commit Updated Build MD and Update JSON Files
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: update
          skip_checkout: true
          file_pattern: build.md *-update.json
          commit_message: Bump version ${{ steps.next_ver_code.outputs.NEXT_VER_CODE }}

  cleanup:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Delete Older Releases and Workflows
        uses: ophub/delete-releases-workflows@main
        with:
          delete_releases: true
          delete_tags: true
          releases_keep_latest: 100
          delete_workflows: true
          workflows_keep_day: 3
          gh_token: ${{ secrets.GITHUB_TOKEN }}
