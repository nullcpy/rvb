name: Track GitHub Releases

on:
  schedule:
    - cron: "20 15 * * *"
  workflow_dispatch:

concurrency:
  group: patch-build
  cancel-in-progress: false

env:
  TG_CHAT: "@rvb27"
  TG_THREAD_ID: "267"
  BUZZHEAVIER_ACCOUNT_ID: ${{ secrets.BUZZHEAVIER_ACCOUNT_ID }}
  TG_TOKEN: ${{ secrets.TG_TOKEN }}

jobs:
  track-github-releases:
    name: Track GitHub Releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Ensure repos.json exists
        run: |
          mkdir -p .github/misc
          if [ ! -f .github/misc/repos.json ]; then
            echo "{}" > .github/misc/repos.json
          fi

      - name: Check releases and notify
        id: notify
        run: |
          set -euo pipefail
          NL=$'\n'
          FILE=".github/misc/repos.json"
          UPDATED=false

          retry_curl() {
            local url="$1"
            local attempts=5
            local delay=2

            for i in $(seq 1 $attempts); do
              RESPONSE=$(curl -sf \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer $GH_TOKEN" \
                "$url" 2>/dev/null) && break || true

              echo "Curl attempt $i failed. Retrying in $delay seconds..."
              sleep $delay
              delay=$((delay * 2))
            done

            echo "$RESPONSE"
          }

          for repo in $(jq -r 'keys[]' "$FILE"); do
            LAST_TAG=$(jq -r --arg r "$repo" '.[$r] // ""' "$FILE")

            echo "Checking $repo (last: ${LAST_TAG:-none})"

            RESPONSE=$(retry_curl "https://api.github.com/repos/$repo/releases/latest")

            if [ -z "$RESPONSE" ] || [ "$(echo "$RESPONSE" | jq 'type != "object"')" = "true" ]; then
              echo "API returned empty or invalid JSON. Skipping."
              continue
            fi

            NEW_TAG=$(echo "$RESPONSE" | jq -r '.tag_name // ""')
            if [ -z "$NEW_TAG" ] || [ "$NEW_TAG" = "$LAST_TAG" ]; then
              echo "No new release for $repo"
              continue
            fi

            echo "New release for $repo: $NEW_TAG"

            jq --arg r "$repo" --arg t "$NEW_TAG" '.[$r] = $t' "$FILE" > "$FILE.tmp"
            mv "$FILE.tmp" "$FILE"
            UPDATED=true

            NAME=$(echo "$RESPONSE" | jq -r '.name // .tag_name')
            URL=$(echo "$RESPONSE" | jq -r '.html_url')
            ESC_NAME=$(printf "%s" "$NAME" | sed 's/_/\\_/g; s/\*/\\*/g; s/\[/\\[/g; s/\]/\\]/g')

            MSG="*${repo}*: [${ESC_NAME}](${URL})${NL}${NL}"

            ASSETS=$(echo "$RESPONSE" | jq -c '.assets // []')
            if [ "$(echo "$ASSETS" | jq 'length')" -gt 0 ]; then
              MSG+="*Download:*${NL}"
              
              while read -r asset; do
                NAME=$(echo "$asset" | jq -r '.name')
                DL=$(echo "$asset" | jq -r '.browser_download_url')
                ESC=$(printf "%s" "$NAME" | sed 's/_/\\_/g; s/\*/\\*/g; s/\[/\\[/g; s/\]/\\]/g')
                MSG+="[${ESC}](${DL})${NL}${NL}"
              done < <(echo "$ASSETS" | jq -c '.[]')
              
            else
              MSG+="Nothing to download.${NL}"
            fi

            curl -s -X POST \
              --data-urlencode "chat_id=${TG_CHAT}" \
              --data-urlencode "message_thread_id=${TG_THREAD_ID}" \
              --data-urlencode "parse_mode=Markdown" \
              --data-urlencode "disable_web_page_preview=true" \
              --data-urlencode "text=${MSG:0:9450}" \
              "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" >/dev/null

            sleep 1
          done

          echo "updated=$UPDATED" >> "$GITHUB_OUTPUT"

      - name: Commit updated repos.json
        if: steps.notify.outputs.updated == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/repos.json
          commit_message: "Update tracked release versions"

  track-fiorenmas-apks:
    name: Track FiorenMas APK Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: track-github-releases
    if: always()
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Compute message date (UTC)
        id: msg_date
        run: |
          set -euo pipefail
          DATE_UTC="$(TZ=UTC date +'%Y-%m-%d')"
          STAMP="$(TZ=UTC date +'%Y%m%d-%H%M')"
          DATE_FOLDER="$(TZ=UTC date +'%Y%m%d')"
          echo "DATE_UTC=$DATE_UTC" >> "$GITHUB_OUTPUT"
          echo "STAMP=$STAMP" >> "$GITHUB_OUTPUT"
          echo "DATE_FOLDER=$DATE_FOLDER" >> "$GITHUB_OUTPUT"

      - name: Fetch APK Assets (FiorenMas Repo)
        run: |
          set -euo pipefail
          mkdir -p .github/misc
          curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/tags/all" \
            | jq -r '
              (.assets // [])
              | map(select(.name | endswith(".apk")))
              | map({ name: .name, updated_at: .updated_at, url: .browser_download_url })
            ' \
            > .github/misc/current_apks.json

      - name: Initialize Timestamp File if Missing
        id: init_file
        run: |
          set -euo pipefail
          FILE=".github/misc/apk_timestamps.json"
          if [ ! -f "$FILE" ]; then
            jq -s 'add // [] | reduce .[] as $a ({}; .[$a.name] = $a.updated_at)' \
              .github/misc/current_apks.json > "$FILE"
            echo "missing=true" >> "$GITHUB_OUTPUT"
          else
            echo "missing=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Initialized Timestamp File
        if: steps.init_file.outputs.missing == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/apk_timestamps.json
          commit_message: "Initialize apk_timestamps.json"

      - name: Compare and Detect Changes
        id: compare
        run: |
          set -euo pipefail
          CURRENT=".github/misc/current_apks.json"
          STORED=".github/misc/apk_timestamps.json"

          # Save changed assets as JSON for later download
          jq -nr \
            --argjson cur "$(cat "$CURRENT")" \
            --argjson old "$(cat "$STORED")" \
            '
            [$cur[] | select(.updated_at != ($old[.name] // ""))]
            ' > /tmp/changed_apks.json

          if [ "$(jq 'length' /tmp/changed_apks.json)" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"

            # Update stored timestamps to current snapshot
            jq -s 'add // [] | reduce .[] as $a ({}; .[$a.name] = $a.updated_at)' \
              "$CURRENT" > "$STORED"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Updated Timestamps
        if: steps.compare.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/apk_timestamps.json
          commit_message: "Update apk timestamps"

      - name: Download changed APKs
        if: steps.compare.outputs.changed == 'true'
        run: |
          set -euo pipefail
          mkdir -p build

          jq -r '.[] | [.name, .updated_at, .url] | @tsv' /tmp/changed_apks.json | while IFS=$'\t' read -r NAME UPDATED_AT URL; do

            echo "â¬‡ï¸ Downloading: $NAME ($UPDATED_AT)"
            curl -L --fail --retry 5 --retry-delay 2 --connect-timeout 30 --max-time 600 \
              -o "build/$NAME" "$URL"
          done

      - name: Create archive
        if: steps.compare.outputs.changed == 'true'
        id: make_archive
        run: |
          set -euo pipefail
          cd build || { echo "build folder not found"; exit 1; }

          DATE_FOLDER="${{ steps.msg_date.outputs.DATE_FOLDER }}"
          ARCHIVE_NAME="archive-${DATE_FOLDER}.zip"

          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> "$GITHUB_OUTPUT"

          echo "ðŸ“¦ Creating archive: $ARCHIVE_NAME"
          zip -q9 "$ARCHIVE_NAME" ./*

      - name: Upload to BuzzHeavier
        if: steps.compare.outputs.changed == 'true'
        id: upload_buzzheavier
        run: |
          set -euo pipefail
          cd build || { echo "build folder not found"; exit 1; }

          TOKEN=$(echo "$BUZZHEAVIER_ACCOUNT_ID" | xargs)
          if [ -z "$TOKEN" ]; then
            echo "âŒ BUZZHEAVIER_ACCOUNT_ID secret is missing"
            exit 1
          fi
          AUTH="Authorization: Bearer $TOKEN"

          # Your parent folder ID (keep as-is or change)
          PARENT_ID="cu7dlibbciic"
          DATE_FOLDER="${{ steps.msg_date.outputs.DATE_FOLDER }}"

          echo "âœ… Using parent directory ID: $PARENT_ID"
          echo "ðŸ“ Creating date folder: $DATE_FOLDER"

          # Create or get date folder (e.g., 20260127)
          PARENT_CONTENTS=$(curl -sS -H "$AUTH" "https://buzzheavier.com/api/fs/$PARENT_ID")

          # Guard against null/empty responses before iterating
          if [ -z "$PARENT_CONTENTS" ] || [ "$(echo "$PARENT_CONTENTS" | jq -r '.data | type // ""')" != "object" ]; then
            echo "âŒ Failed to fetch parent contents for $PARENT_ID"
            echo "Response: $PARENT_CONTENTS"
            exit 1
          fi

          DATE_FOLDER_ID=$(echo "$PARENT_CONTENTS" | jq -r \
            ".data.children // [] | map(select(.name == \"$DATE_FOLDER\" and .isDirectory == true)) | .[0].id // \"\"")

          if [ -z "$DATE_FOLDER_ID" ]; then
            echo "ðŸ“ Date folder doesn't exist, creating: $DATE_FOLDER"
            DATE_FOLDER_RES=$(curl -sS -X POST \
              -H "$AUTH" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"$DATE_FOLDER\"}" \
              "https://buzzheavier.com/api/fs/$PARENT_ID")
            DATE_FOLDER_ID=$(echo "$DATE_FOLDER_RES" | jq -r '.data.id // empty')
            if [ -z "$DATE_FOLDER_ID" ]; then
              echo "âŒ Failed to create date folder. Response: $DATE_FOLDER_RES"
              exit 1
            fi
            echo "âœ… Date folder created with ID: $DATE_FOLDER_ID"
          else
            echo "âœ… Using existing date folder ID: $DATE_FOLDER_ID"
          fi

          # Now use DATE_FOLDER_ID as the upload destination
          RELEASE_DIR_ID="$DATE_FOLDER_ID"

          SUCCESS_COUNT=0
          for FILE in *; do
            if [ -f "$FILE" ]; then
              echo "â¬†ï¸ Uploading $FILE..."
              if curl -# -T "$FILE" -H "$AUTH" "https://w.buzzheavier.com/$RELEASE_DIR_ID/$FILE"; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "âš ï¸ Failed to upload $FILE"
              fi
            fi
          done

          if [ "$SUCCESS_COUNT" -gt 0 ]; then
            PUBLIC_LINK="https://buzzheavier.com/$RELEASE_DIR_ID"
            echo "BUZZHEAVIER_LINK=$PUBLIC_LINK" >> "$GITHUB_OUTPUT"
            echo "UPLOAD_SUCCESS=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Uploaded $SUCCESS_COUNT files. Mirror: $PUBLIC_LINK"
          else
            echo "UPLOAD_SUCCESS=false" >> "$GITHUB_OUTPUT"
            echo "BUZZHEAVIER_LINK=" >> "$GITHUB_OUTPUT"
            echo "âŒ No files uploaded to BuzzHeavier."
          fi

          echo "ðŸ§¹ Scanning for stale empty folders..."
          CLEANUP_CONTENTS=$(curl -sS -H "$AUTH" "https://buzzheavier.com/api/fs/$PARENT_ID")

          CANDIDATE_IDS=$(echo "$CLEANUP_CONTENTS" | jq -r ".data.children[] // [] | select(.isDirectory == true and .id != \"$RELEASE_DIR_ID\") | .id")

          for CID in $CANDIDATE_IDS; do
            CHILD_INFO=$(curl -sS -H "$AUTH" "https://buzzheavier.com/api/fs/$CID")
            
            ITEM_COUNT=$(echo "$CHILD_INFO" | jq '.data.children // [] | length')

            if [ "$ITEM_COUNT" -eq "0" ]; then
               echo "ðŸ—‘ï¸ Folder ID $CID is EMPTY (stale). Deleting..."
               curl -sS -X DELETE -H "$AUTH" "https://buzzheavier.com/api/fs/$CID" || true
            fi
          done

      - name: Upload to Filebin
        if: steps.compare.outputs.changed == 'true'
        id: upload_filebin
        run: |
          set -euo pipefail
          cd build || { echo "build folder not found"; exit 1; }

          DATE_FOLDER="${{ steps.msg_date.outputs.DATE_FOLDER }}"
          ARCHIVE_NAME="${{ steps.make_archive.outputs.ARCHIVE_NAME }}"

          if [ ! -f "$ARCHIVE_NAME" ]; then
            echo "âŒ Expected archive $ARCHIVE_NAME not found!"
            exit 1
          fi

          BIN_ID="fiorenmas-${DATE_FOLDER}-${{ github.run_id }}-${{ github.run_attempt }}"
          FILEBIN_URL="https://filebin.net"

          echo "â¬†ï¸ Uploading $ARCHIVE_NAME to Filebin bin: $BIN_ID"
          if curl --connect-timeout 30 --max-time 600 --fail-with-body \
            --upload-file "$ARCHIVE_NAME" "$FILEBIN_URL/$BIN_ID/$ARCHIVE_NAME"; then
            echo "âœ… $ARCHIVE_NAME uploaded to Filebin"

            if curl --connect-timeout 10 --max-time 30 --fail-with-body -X PUT "$FILEBIN_URL/$BIN_ID"; then
              echo "ðŸ”’ Bin locked successfully."
            else
              echo "âš ï¸ Failed to lock bin (not critical)."
            fi

            echo "UPLOAD_SUCCESS=true" >> "$GITHUB_OUTPUT"
            echo "FILEBIN_LINK=$FILEBIN_URL/$BIN_ID/$ARCHIVE_NAME" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ Failed to upload $ARCHIVE_NAME to Filebin."
            echo "UPLOAD_SUCCESS=false" >> "$GITHUB_OUTPUT"
            echo "FILEBIN_LINK=" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify Telegram
        if: steps.compare.outputs.changed == 'true'
        env:
          DATE_UTC: ${{ steps.msg_date.outputs.DATE_UTC }}
          BUZZ_LINK: ${{ steps.upload_buzzheavier.outputs.BUZZHEAVIER_LINK }}
          FILEBIN_LINK: ${{ steps.upload_filebin.outputs.FILEBIN_LINK }}
        run: |
          set -euo pipefail
          NL=$'\n'

          esc_md () { printf "%s" "$1" | sed 's/_/\\_/g; s/\*/\\*/g; s/\[/\\[/g; s/\]/\\]/g'; }

          HEADER="*Build ${DATE_UTC}*"

          MSG="$HEADER${NL}${NL}*Download:*${NL}[Obtainium](https://github.com/nullcpy/rvb/blob/main/.github/pages/FiorenMas.md)${NL}${NL}[GitHub](https://github.com/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/tag/all)${NL}"

          if [ -n "${BUZZ_LINK:-}" ]; then
            MSG+="${NL}[BuzzHeavier]($BUZZ_LINK)${NL}"
          fi
          if [ -n "${FILEBIN_LINK:-}" ]; then
            MSG+="${NL}[Filebin]($FILEBIN_LINK)${NL}"
          fi

          curl -s -X POST \
            --data-urlencode "chat_id=${TG_CHAT}" \
            --data-urlencode "message_thread_id=1410" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "text=${MSG:0:9450}" \
            "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" >/dev/null

      - name: Update Mirror Links
        if: steps.compare.outputs.changed == 'true'
        id: update_mirrors
        env:
          DATE_UTC: ${{ steps.msg_date.outputs.DATE_UTC }}
          BUZZ_LINK: ${{ steps.upload_buzzheavier.outputs.BUZZHEAVIER_LINK }}
          FILEBIN_LINK: ${{ steps.upload_filebin.outputs.FILEBIN_LINK }}
        run: |
          set -euo pipefail

          MIRRORS_DIR=".github/pages"
          MIRRORS_FILE="$MIRRORS_DIR/fiorenmas-mirrors.md"
          mkdir -p "$MIRRORS_DIR"

          if [ ! -f "$MIRRORS_FILE" ]; then
            echo "# ðŸ—ƒï¸ FiorenMas Mirrors" > "$MIRRORS_FILE"
            echo "Updated automatically. Only recent 100 builds retained." >> "$MIRRORS_FILE"
            echo "" >> "$MIRRORS_FILE"
          fi

          if [ -z "$DATE_UTC" ]; then
            echo "âš ï¸ No date available â€” skipping mirror update"
            exit 0
          fi

          ENTRY="## Build $DATE_UTC  \n"
          if [ -n "$BUZZ_LINK" ]; then
            ENTRY+="ðŸ”— [BuzzHeavier]($BUZZ_LINK)  \n"
          fi
          if [ -n "$FILEBIN_LINK" ]; then
            ENTRY+="ðŸ”— [Filebin]($FILEBIN_LINK)  \n"
          fi
          if [ -z "$BUZZ_LINK" ] && [ -z "$FILEBIN_LINK" ]; then
            ENTRY+="âš ï¸ No mirrors available. Check [GitHub Release](https://github.com/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/tag/all).  \n"
          fi
          ENTRY+="\n"

          {
            # Keep header (first 3 lines)
            head -n 3 "$MIRRORS_FILE"
            # Add new entry
            echo -e "$ENTRY"
            # Add old entries (skip first 3 lines), keep only 99 blocks
            tail -n +4 "$MIRRORS_FILE" | awk 'BEGIN { block_count=0 } /^## Build / { if (block_count >= 99) { exit } block_count++ } block_count <= 99 { print }'
          } > "$MIRRORS_FILE.tmp" && mv "$MIRRORS_FILE.tmp" "$MIRRORS_FILE"

      - name: Commit Updated fiorenmas-mirrors.md
        if: steps.compare.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/pages/fiorenmas-mirrors.md
          commit_message: "Update fiorenmas-mirrors.md for ${{ steps.msg_date.outputs.DATE_UTC }}"
