name: Track GitHub Releases

on:
  schedule:
    - cron: "20 15 * * *"
  workflow_dispatch:

concurrency:
  group: patch-build
  cancel-in-progress: false

jobs:
  track-github-releases:
    name: Track GitHub Releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Ensure repos.json exists
        run: |
          mkdir -p .github/misc
          if [ ! -f .github/misc/repos.json ]; then
            echo "{}" > .github/misc/repos.json
          fi

      - name: Check releases and notify
        id: notify
        run: |
          set -euo pipefail
          NL=$'\n'
          FILE=".github/misc/repos.json"
          UPDATED=false

          retry_curl() {
            local url="$1"
            local attempts=5
            local delay=2

            for i in $(seq 1 $attempts); do
              RESPONSE=$(curl -sf \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer $GH_TOKEN" \
                "$url" 2>/dev/null) && break || true

              echo "Curl attempt $i failed. Retrying in $delay seconds..."
              sleep $delay
              delay=$((delay * 2))
            done

            echo "$RESPONSE"
          }

          for repo in $(jq -r 'keys[]' "$FILE"); do
            LAST_TAG=$(jq -r --arg r "$repo" '.[$r] // ""' "$FILE")

            echo "Checking $repo (last: ${LAST_TAG:-none})"

            RESPONSE=$(retry_curl "https://api.github.com/repos/$repo/releases/latest")

            if [ -z "$RESPONSE" ] || [ "$(echo "$RESPONSE" | jq 'type != "object"')" = "true" ]; then
              echo "API returned empty or invalid JSON. Skipping."
              continue
            fi

            NEW_TAG=$(echo "$RESPONSE" | jq -r '.tag_name // ""')
            if [ -z "$NEW_TAG" ] || [ "$NEW_TAG" = "$LAST_TAG" ]; then
              echo "No new release for $repo"
              continue
            fi

            echo "New release for $repo: $NEW_TAG"

            jq --arg r "$repo" --arg t "$NEW_TAG" '.[$r] = $t' "$FILE" > "$FILE.tmp"
            mv "$FILE.tmp" "$FILE"
            UPDATED=true
          done

          echo "updated=$UPDATED" >> "$GITHUB_OUTPUT"

      - name: Commit updated repos.json
        if: steps.notify.outputs.updated == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/repos.json
          commit_message: "Update tracked release versions"

  track-fiorenmas-apks:
    name: Track FiorenMas APK Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: track-github-releases
    if: always()
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 1

      - name: Compute message date (UTC)
        id: msg_date
        run: |
          set -euo pipefail
          DATE_UTC="$(TZ=UTC date +'%Y-%m-%d')"
          STAMP="$(TZ=UTC date +'%Y%m%d-%H%M')"
          DATE_FOLDER="$(TZ=UTC date +'%Y%m%d')"
          echo "DATE_UTC=$DATE_UTC" >> "$GITHUB_OUTPUT"
          echo "STAMP=$STAMP" >> "$GITHUB_OUTPUT"
          echo "DATE_FOLDER=$DATE_FOLDER" >> "$GITHUB_OUTPUT"

      - name: Fetch APK Assets (FiorenMas Repo)
        run: |
          set -euo pipefail
          mkdir -p .github/misc
          curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/tags/all" \
            | jq -r '
              (.assets // [])
              | map(select(.name | endswith(".apk")))
              | map({ name: .name, updated_at: .updated_at, url: .browser_download_url })
            ' \
            > .github/misc/current_apks.json

      - name: Initialize Timestamp File if Missing
        id: init_file
        run: |
          set -euo pipefail
          FILE=".github/misc/apk_timestamps.json"
          if [ ! -f "$FILE" ]; then
            jq -s 'add // [] | reduce .[] as $a ({}; .[$a.name] = $a.updated_at)' \
              .github/misc/current_apks.json > "$FILE"
            echo "missing=true" >> "$GITHUB_OUTPUT"
          else
            echo "missing=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Initialized Timestamp File
        if: steps.init_file.outputs.missing == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/apk_timestamps.json
          commit_message: "Initialize apk_timestamps.json"

      - name: Compare and Detect Changes
        id: compare
        run: |
          set -euo pipefail
          CURRENT=".github/misc/current_apks.json"
          STORED=".github/misc/apk_timestamps.json"

          # Save changed assets as JSON for later download
          jq -nr \
            --argjson cur "$(cat "$CURRENT")" \
            --argjson old "$(cat "$STORED")" \
            '
            [$cur[] | select(.updated_at != ($old[.name] // ""))]
            ' > /tmp/changed_apks.json

          if [ "$(jq 'length' /tmp/changed_apks.json)" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"

            # Update stored timestamps to current snapshot
            jq -s 'add // [] | reduce .[] as $a ({}; .[$a.name] = $a.updated_at)' \
              "$CURRENT" > "$STORED"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Updated Timestamps
        if: steps.compare.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: main
          skip_checkout: true
          file_pattern: .github/misc/apk_timestamps.json
          commit_message: "Update apk timestamps"

      - name: Download changed APKs
        if: steps.compare.outputs.changed == 'true'
        run: |
          set -euo pipefail
          mkdir -p build

          jq -r '.[] | [.name, .updated_at, .url] | @tsv' /tmp/changed_apks.json | while IFS=$'\t' read -r NAME UPDATED_AT URL; do

            echo "⬇️ Downloading: $NAME ($UPDATED_AT)"
            curl -L --fail --retry 5 --retry-delay 2 --connect-timeout 30 --max-time 600 \
              -o "build/$NAME" "$URL"
          done
